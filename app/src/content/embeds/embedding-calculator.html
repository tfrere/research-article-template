<div class="d3-embedding-calculator"></div>

<style>
  .d3-embedding-calculator {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.5;
    color: var(--text-color);
  }

  .d3-embedding-calculator .controls-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  .d3-embedding-calculator .slider-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    position: relative;
  }

  .d3-embedding-calculator .slider-group label {
    font-size: 0.8em;
    font-weight: 700;
    color: var(--text-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .d3-embedding-calculator .slider-value {
    font-size: 0.75em;
    color: var(--muted-color);
    font-weight: 600;
  }

  /* Slider styling */
  .d3-embedding-calculator input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
    height: 6px;
    border-radius: 3px;
    position: relative;
  }

  /* Slider container for progress bar */
  .d3-embedding-calculator .slider-group::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    pointer-events: none;
  }

  .d3-embedding-calculator .slider-group::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: var(--progress-width, 0%);
    height: 6px;
    background: var(--primary-color);
    border-radius: 3px;
    pointer-events: none;
    transition: width 0.1s ease;
  }

  /* Webkit slider thumb */
  .d3-embedding-calculator input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    background: var(--primary-color);
    height: 18px;
    width: 18px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--page-bg);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  /* Firefox slider thumb */
  .d3-embedding-calculator input[type="range"]::-moz-range-thumb {
    background: var(--primary-color);
    height: 18px;
    width: 18px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--page-bg);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .d3-embedding-calculator .results-summary {
    margin: 20px 0 24px 0;
    text-align: center;
  }

  .d3-embedding-calculator .summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }

  .d3-embedding-calculator .summary-card {
    background: var(--page-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
  }

  .d3-embedding-calculator .summary-label {
    font-size: 0.7em;
    color: var(--text-color);
    margin-bottom: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .d3-embedding-calculator .summary-value {
    font-weight: 700;
    color: var(--primary-color);
    font-size: 1.1em;
    line-height: 1.2;
  }

  .d3-embedding-calculator .savings-highlight {
    background: color-mix(in srgb, var(--primary-color) 10%, transparent);
    border: 1px solid color-mix(in srgb, var(--primary-color) 30%, var(--border-color));
    border-radius: 8px;
    padding: 12px 16px;
    color: var(--primary-color);
    font-weight: 600;
    font-size: 0.9em;
    display: inline-block;
  }

  .d3-embedding-calculator .comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0 0 0;
  }

  .d3-embedding-calculator .network-side {
    background: var(--page-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    position: relative;
  }

  .d3-embedding-calculator .no-tying {}

  .d3-embedding-calculator .with-tying {
    position: relative;
  }

  .d3-embedding-calculator .sharing-arrow {
    position: absolute;
    right: 20px;
    top: 240px;
    bottom: 100px;
    width: 2px;
    background: var(--primary-color);
    z-index: 10;
  }

  .d3-embedding-calculator .sharing-arrow::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 25px;
    height: 2px;
    background: var(--primary-color);
  }

  .d3-embedding-calculator .sharing-arrow::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 25px;
    height: 2px;
    background: var(--primary-color);
  }

  .d3-embedding-calculator .arrow-head-top {
    position: absolute;
    top: -3px;
    left: -25px;
    width: 0;
    height: 0;
    border-right: 6px solid var(--primary-color);
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .d3-embedding-calculator .arrow-head-bottom {
    position: absolute;
    bottom: -3px;
    left: -25px;
    width: 0;
    height: 0;
    border-right: 6px solid var(--primary-color);
    border-top: 4px solid transparent;
    border-bottom: 4px solid transparent;
  }

  .d3-embedding-calculator .network-icon {
    font-size: 0.8em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }

  .d3-embedding-calculator .network-icon.check {
    color: #22c55e;
  }

  .d3-embedding-calculator .network-icon.cross {
    color: #ef4444;
  }

  .d3-embedding-calculator .network-icon-text {
    font-weight: 600;
    font-size: 0.9em;
  }

  .d3-embedding-calculator .network-title {
    font-weight: 700;
    font-size: 1em;
    margin-bottom: 15px;
    color: var(--text-color);
  }

  .d3-embedding-calculator .model-size {
    font-size: 1.1em;
    font-weight: 600;
    margin-bottom: 20px;
  }

  .d3-embedding-calculator .model-size.untied {
    color: color-mix(in srgb, #cc6600 80%, var(--text-color));
  }

  .d3-embedding-calculator .model-size.tied {
    color: var(--primary-color);
  }

  .d3-embedding-calculator .network-layer {
    margin: 15px 0;
  }

  .d3-embedding-calculator .layer-title {
    font-size: 0.8em;
    color: var(--muted-color);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .d3-embedding-calculator .matrix-visual {
    display: inline-block;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 10px;
    background: var(--surface-bg);
    margin: 5px 0;
  }

  .d3-embedding-calculator .matrix-grid {
    display: grid;
    gap: 2px;
    margin: 8px 0;
  }

  .d3-embedding-calculator .matrix-cell {
    width: 12px;
    height: 12px;
    background: var(--primary-color);
    border-radius: 2px;
  }


  .d3-embedding-calculator .matrix-label {
    font-size: 0.7em;
    color: var(--muted-color);
    margin: 5px 0;
    font-family: 'Courier New', monospace;
  }

  .d3-embedding-calculator .neurons-layer {
    display: flex;
    justify-content: center;
    gap: 4px;
    margin: 12px 0;
    flex-wrap: wrap;
  }

  .d3-embedding-calculator .neuron {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--muted-color);
  }

  .d3-embedding-calculator .dots {
    font-size: 1.2em;
    color: var(--muted-color);
    margin: 10px 0;
  }

  .d3-embedding-calculator .connection-line {
    width: 2px;
    height: 15px;
    background: var(--border-color);
    margin: 0 auto;
  }


  .d3-embedding-calculator .results-detail {
    background: var(--page-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }

  .d3-embedding-calculator .result-item {
    margin: 12px 0;
    font-size: 0.9em;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .d3-embedding-calculator .result-value {
    font-weight: 600;
    color: var(--primary-color);
  }

  .d3-embedding-calculator .savings {
    color: var(--primary-color);
    font-weight: 600;
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .d3-embedding-calculator .controls-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .d3-embedding-calculator .comparison {
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .d3-embedding-calculator .summary-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }

  }

  @media (max-width: 480px) {
    .d3-embedding-calculator {
      padding: 16px;
    }

    .d3-embedding-calculator .results-summary,
    .d3-embedding-calculator .results-detail {
      padding: 16px;
    }

    .d3-embedding-calculator .network-side {
      padding: 16px;
    }
  }
</style>

<script>
  (() => {
    const bootstrap = () => {
      const scriptEl = document.currentScript;
      let container = scriptEl ? scriptEl.previousElementSibling : null;
      if (!(container && container.classList && container.classList.contains('d3-embedding-calculator'))) {
        const candidates = Array.from(document.querySelectorAll('.d3-embedding-calculator'))
          .filter((el) => !(el.dataset && el.dataset.mounted === 'true'));
        container = candidates[candidates.length - 1] || null;
      }
      if (!container) return;
      if (container.dataset) {
        if (container.dataset.mounted === 'true') return;
        container.dataset.mounted = 'true';
      }

      // Create the calculator interface
      container.innerHTML = `
        <div class="controls-grid">
          <div class="slider-group">
            <label for="vocabSize">Vocabulary Size <span class="slider-value" id="vocabValue">128k</span></label>
            <input type="range" id="vocabSize" min="32000" max="256000" step="1000" value="128000">
          </div>
          <div class="slider-group">
            <label for="hiddenSize">Hidden Size <span class="slider-value" id="hiddenValue">2048</span></label>
            <input type="range" id="hiddenSize" min="512" max="8192" step="64" value="2048">
          </div>
          <div class="slider-group">
            <label for="modelSize">Total Model Size (M) <span class="slider-value" id="modelValue">1460M</span></label>
            <input type="range" id="modelSize" min="100" max="10000" step="100" value="1460">
          </div>
        </div>
        
        <div class="results-summary">
          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-label">Total Embedding Parameters</div>
              <div class="summary-value" id="totalEmbeddingTop">524M</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Percentage of Model</div>
              <div class="summary-value" id="percentageTop">44%</div>
            </div>
            <div class="summary-card">
              <div class="summary-label">Weight Tying Savings</div>
              <div class="summary-value" id="savingsTop">262M (22%)</div>
            </div>
          </div>
        </div>
        
        <div class="comparison">
          <div class="network-side no-tying">
            <div class="network-icon cross"></div>
            <div class="network-title">Separate Embeddings</div>
            <div class="model-size untied" id="modelSizeUntied">1.46B</div>
            
            <div class="network-layer">
              <div class="layer-title">Input Embedding</div>
              <div class="matrix-visual">
                <div class="matrix-grid" id="inputMatrix1"></div>
                <div class="matrix-label" id="inputDim1">128k × 2048</div>
              </div>
            </div>
            
            <div class="connection-line"></div>
            
            <div class="network-layer">
              <div class="layer-title">Layer 1</div>
              <div class="neurons-layer" id="neurons1"></div>
            </div>
            
            <div class="dots">⋮</div>
            
            <div class="network-layer">
              <div class="layer-title">Layer N</div>
              <div class="neurons-layer" id="neurons2"></div>
            </div>
            
            <div class="connection-line"></div>
            
            <div class="network-layer">
              <div class="layer-title">Output Projection</div>
              <div class="matrix-visual">
                <div class="matrix-grid" id="outputMatrix1"></div>
                <div class="matrix-label" id="outputDim1">2048 × 128k</div>
              </div>
            </div>
          </div>
          
          <div class="network-side with-tying">
            <div class="network-icon check"></div>
            <div class="network-title">Tied Embeddings</div>
            <div class="model-size tied" id="modelSizeTied">1.20B</div>
            <div class="sharing-arrow">
              <div class="arrow-head-top"></div>
              <div class="arrow-head-bottom"></div>
            </div>
            
            <div class="network-layer">
              <div class="layer-title">Input Embedding</div>
              <div class="matrix-visual">
                <div class="matrix-grid" id="inputMatrix2"></div>
                <div class="matrix-label" id="inputDim2">128k × 2048</div>
              </div>
            </div>
            
            <div class="connection-line"></div>
            
            <div class="network-layer">
              <div class="layer-title">Layer 1</div>
              <div class="neurons-layer" id="neurons3"></div>
            </div>
            
            <div class="dots">⋮</div>
            
            <div class="network-layer">
              <div class="layer-title">Layer N</div>
              <div class="neurons-layer" id="neurons4"></div>
            </div>
            
            <div class="connection-line"></div>
            
            <div class="network-layer">
              <div class="layer-title">Output Projection (Shared)</div>
              <div class="matrix-visual">
                <div class="matrix-grid" id="outputMatrix2"></div>
                <div class="matrix-label" id="outputDim2">2048 × 128k</div>
              </div>
            </div>
            
          </div>
        </div>
        
      `;

      function createMatrix(containerId, rows, cols, isOutput = false, isSeparate = true, color = null) {
        const container = document.getElementById(containerId);

        if (isOutput) {
          // Output matrices (2048 × 128k) - MORE COLUMNS than rows (transposed)
          container.style.gridTemplateColumns = `repeat(${Math.min(cols, 12)}, 1fr)`;
          const totalCells = Math.min(rows * cols, 64);
          container.innerHTML = '';

          for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'matrix-cell';
            if (isSeparate) {
              cell.classList.add('output-separate');
            }
            if (color) {
              cell.style.backgroundColor = color;
            }
            container.appendChild(cell);
          }
        } else {
          // Input matrices (128k × 2048) - more rows than columns
          container.style.gridTemplateColumns = `repeat(${Math.min(cols, 8)}, 1fr)`;
          const totalCells = Math.min(rows * cols, 64);
          container.innerHTML = '';

          for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'matrix-cell';
            if (color) {
              cell.style.backgroundColor = color;
            }
            container.appendChild(cell);
          }
        }
      }

      function createNeurons(containerId, count) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        const displayCount = Math.min(count, 12);
        for (let i = 0; i < displayCount; i++) {
          const neuron = document.createElement('div');
          neuron.className = 'neuron';
          container.appendChild(neuron);
        }
      }

      function updateSliderValues() {
        const vocabSize = parseInt(container.querySelector('#vocabSize').value) || 0;
        const hiddenSize = parseInt(container.querySelector('#hiddenSize').value) || 0;
        const modelSize = parseInt(container.querySelector('#modelSize').value) || 0;

        container.querySelector('#vocabValue').innerHTML = vocabSize >= 1000 ? `${(vocabSize / 1000).toFixed(0)} <span style="opacity: 0.6;">k</span>` : vocabSize.toString();
        container.querySelector('#hiddenValue').textContent = hiddenSize.toString();
        container.querySelector('#modelValue').innerHTML = `${modelSize} <span style="opacity: 0.6;">M</span>`;

        // Update progress bars
        const vocabSlider = container.querySelector('#vocabSize').parentElement;
        const hiddenSlider = container.querySelector('#hiddenSize').parentElement;
        const modelSlider = container.querySelector('#modelSize').parentElement;

        const vocabProgress = ((vocabSize - 32000) / (256000 - 32000)) * 100;
        const hiddenProgress = ((hiddenSize - 512) / (8192 - 512)) * 100;
        const modelProgress = ((modelSize - 100) / (10000 - 100)) * 100;

        vocabSlider.style.setProperty('--progress-width', `${vocabProgress}%`);
        hiddenSlider.style.setProperty('--progress-width', `${hiddenProgress}%`);
        modelSlider.style.setProperty('--progress-width', `${modelProgress}%`);
      }

      function updateVisualizations() {
        const vocabSize = parseInt(container.querySelector('#vocabSize').value) || 0;
        const hiddenSize = parseInt(container.querySelector('#hiddenSize').value) || 0;

        // Get categorical colors for input and output projections
        let inputColor = 'var(--primary-color)';
        let outputColor = 'var(--primary-color)';

        try {
          if (window.ColorPalettes && typeof window.ColorPalettes.getColors === 'function') {
            const colors = window.ColorPalettes.getColors('categorical', 2);
            if (colors && colors.length >= 2) {
              inputColor = colors[0];
              outputColor = colors[1];
            }
          }
        } catch (_) { }

        // Calculate display dimensions (scaled for visualization)
        const vocabDisplay = Math.min(Math.ceil(Math.sqrt(vocabSize / 5000)), 8);
        const hiddenDisplay = Math.min(Math.ceil(Math.sqrt(hiddenSize / 200)), 8);
        const neuronCount = Math.min(hiddenSize / 200, 12);

        // Update matrix visualizations with different colors
        createMatrix('inputMatrix1', vocabDisplay, hiddenDisplay, false, true, inputColor);
        createMatrix('outputMatrix1', hiddenDisplay, vocabDisplay, true, true, outputColor); // Transposed for output
        createMatrix('inputMatrix2', vocabDisplay, hiddenDisplay, false, false, inputColor);
        createMatrix('outputMatrix2', hiddenDisplay, vocabDisplay, true, false, inputColor); // Transposed, shared (same as input)

        // Update neurons
        createNeurons('neurons1', neuronCount);
        createNeurons('neurons2', neuronCount);
        createNeurons('neurons3', neuronCount);
        createNeurons('neurons4', neuronCount);

        // Update dimensions labels
        const vocabK = vocabSize >= 1000 ? `${Math.round(vocabSize / 1000)}k` : vocabSize;
        const hiddenK = hiddenSize >= 1000 ? `${Math.round(hiddenSize / 1000)}k` : hiddenSize;

        container.querySelector('#inputDim1').textContent = `${vocabK} × ${hiddenK}`;
        container.querySelector('#outputDim1').textContent = `${hiddenK} × ${vocabK}`;
        container.querySelector('#inputDim2').textContent = `${vocabK} × ${hiddenK}`;
        container.querySelector('#outputDim2').innerHTML = `${hiddenK} × ${vocabK}<br><span style="font-size: 0.8em; opacity: 0.7;">(Transposed)</span>`;
      }

      function updateCalculations() {
        const vocabSize = parseInt(container.querySelector('#vocabSize').value) || 0;
        const hiddenSize = parseInt(container.querySelector('#hiddenSize').value) || 0;
        const modelSize = parseInt(container.querySelector('#modelSize').value) || 0;

        updateSliderValues();

        const embeddingParams = vocabSize * hiddenSize;
        const totalEmbeddingParams = embeddingParams * 2; // Input + Output
        const percentage = modelSize > 0 ? ((totalEmbeddingParams / (modelSize * 1000000)) * 100).toFixed(0) : 0;
        const savings = embeddingParams;
        const savingsPercentage = modelSize > 0 ? ((savings / (modelSize * 1000000)) * 100).toFixed(0) : 0;

        // Calculate model sizes (assuming input model size is WITHOUT tying - untied)
        const untiedModelSize = modelSize; // Input model size (without tying)
        const tiedModelSize = modelSize - (savings / 1000000); // Subtract the embedding params saved

        // Format numbers with reduced opacity suffixes
        const formatNumber = (num) => {
          if (num >= 1000000000) return `${(num / 1000000000).toFixed(1)} <span style="opacity: 0.6;">B</span>`;
          if (num >= 1000000) return `${(num / 1000000).toFixed(1)} <span style="opacity: 0.6;">M</span>`;
          if (num >= 1000) return `${(num / 1000).toFixed(0)} <span style="opacity: 0.6;">k</span>`;
          return num.toString();
        };

        // Get categorical colors for model sizes
        let untiedColor = 'color-mix(in srgb, #cc6600 80%, var(--text-color))';
        let tiedColor = 'var(--primary-color)';

        try {
          if (window.ColorPalettes && typeof window.ColorPalettes.getColors === 'function') {
            const colors = window.ColorPalettes.getColors('categorical', 2);
            if (colors && colors.length >= 2) {
              untiedColor = colors[1]; // Use second color for "DON'T"
              tiedColor = colors[0];   // Use first color for "DO"
            }
          }
        } catch (_) { }

        // Update model size displays with colors
        const untiedElement = container.querySelector('#modelSizeUntied');
        const tiedElement = container.querySelector('#modelSizeTied');

        untiedElement.innerHTML = formatNumber(untiedModelSize * 1000000);
        tiedElement.innerHTML = formatNumber(tiedModelSize * 1000000);

        untiedElement.style.color = untiedColor;
        tiedElement.style.color = tiedColor;

        container.querySelector('#totalEmbeddingTop').innerHTML = formatNumber(totalEmbeddingParams);
        container.querySelector('#percentageTop').innerHTML = `${percentage} <span style="opacity: 0.6;">%</span>`;
        container.querySelector('#savingsTop').innerHTML =
          `${formatNumber(savings)} <span style="opacity: 0.6;">(${savingsPercentage}%)</span>`;

        updateVisualizations();
      }

      // Add event listeners
      container.querySelector('#vocabSize').addEventListener('input', updateCalculations);
      container.querySelector('#hiddenSize').addEventListener('input', updateCalculations);
      container.querySelector('#modelSize').addEventListener('input', updateCalculations);

      // Initialize
      updateSliderValues();
      updateCalculations();
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bootstrap, { once: true });
    } else {
      bootstrap();
    }
  })();
</script>