<div class="rl-training-sync"></div>
<style>
    .rl-training-sync {
        font-family: 'Arial', sans-serif;
        margin: 20px 0;
        padding: 0;
    }

    .rl-training-sync .container {
        display: flex;
        gap: 30px;
        align-items: stretch;
        justify-content: center;
        flex-wrap: wrap;
    }

    .rl-training-sync .left-section {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .rl-training-sync .left-diagram {
        position: relative;
        width: 280px;
        height: 320px;
        background: var(--surface-bg, #fafafa);
        border-radius: 12px;
        padding: 10px;
    }

    .rl-training-sync .diagram-separator {
        width: 1px;
        background: linear-gradient(to bottom, transparent, var(--border-color, #ddd) 20%, var(--border-color, #ddd) 80%, transparent);
        align-self: stretch;
    }

    .rl-training-sync .right-modes {
        flex: 1;
        min-width: 400px;
        display: flex;
        align-items: center;
        gap: 0;
    }

    .rl-training-sync .box {
        padding: 8px 14px;
        border-radius: 8px;
        border: 1px solid;
        font-weight: 600;
        font-size: 11px;
        text-align: center;
        position: absolute;
        z-index: 2;
        line-height: 1.3;
        transition: transform 0.2s ease;
        cursor: default;
    }

    .rl-training-sync .rewards {
        background: color-mix(in srgb, var(--color-0, #E889AB) 60%, transparent);
        border-color: var(--color-0, #E889AB);
        color: var(--text-color, #000);
        top: 10px;
        left: 10px;
    }

    .rl-training-sync .verifier {
        background: color-mix(in srgb, var(--color-1, #4EA5B7) 60%, transparent);
        border-color: var(--color-1, #4EA5B7);
        color: var(--text-color, #000);
        top: 10px;
        right: 10px;
    }

    .rl-training-sync .rollouts {
        background: color-mix(in srgb, var(--color-2, #E38A42) 60%, transparent);
        border-color: var(--color-2, #E38A42);
        color: var(--text-color, #000);
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
    }

    .rl-training-sync .trainer {
        background: color-mix(in srgb, var(--color-3, #CEC0FA) 60%, transparent);
        border-color: var(--color-3, #CEC0FA);
        color: var(--text-color, #000);
        bottom: 60px;
        left: 10px;
    }

    .rl-training-sync .generator {
        background: color-mix(in srgb, var(--color-0, #E889AB) 60%, transparent);
        border-color: var(--color-0, #E889AB);
        color: var(--text-color, #000);
        bottom: 60px;
        right: 10px;
    }

    .rl-training-sync .prompt {
        background: color-mix(in srgb, var(--color-1, #4EA5B7) 60%, transparent);
        border-color: var(--color-1, #4EA5B7);
        color: var(--text-color, #000);
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
    }

    /* Arrows */
    .rl-training-sync .arrow {
        stroke: var(--text-color, #666);
        stroke-width: 1.5;
        fill: none;
        opacity: 0.6;
    }

    .rl-training-sync .mode-column {
        flex: 1;
        min-width: 120px;
        padding: 0 15px;
        border-right: 1px solid var(--border-color, #ddd);
        transition: background-color 0.2s ease;
    }

    .rl-training-sync .mode-column:last-child {
        border-right: none;
    }

    .rl-training-sync .mode-header {
        font-size: 13px;
        font-weight: 700;
        text-align: center;
        margin-bottom: 15px;
        color: var(--text-color, #333);
        padding-bottom: 10px;
    }

    .rl-training-sync .step-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
        justify-content: center;
    }

    .rl-training-sync .step-label {
        font-size: 11px;
        font-weight: 600;
        min-width: 60px;
        text-align: right;
        color: var(--muted-color, #666);
    }

    .rl-training-sync .node {
        padding: 7px 15px;
        border-radius: 8px;
        border: 1px solid;
        font-weight: 600;
        font-size: 11px;
        min-width: 38px;
        text-align: center;
        transition: transform 0.2s ease;
    }

    .rl-training-sync .node-t {
        background: color-mix(in srgb, var(--color-3, #CEC0FA) 60%, transparent);
        border-color: var(--color-3, #CEC0FA);
        color: var(--text-color, #000);
    }

    .rl-training-sync .node-g {
        background: color-mix(in srgb, var(--color-0, #E889AB) 60%, transparent);
        border-color: var(--color-0, #E889AB);
        color: var(--text-color, #000);
    }

    .rl-training-sync .sync-arrow {
        position: relative;
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 0px;
        margin-top: -12px;
    }

    .rl-training-sync .sync-label {
        transform: translateY(10px);
        font-size: 8px;
        color: var(--text-color, #666);
        font-weight: 600;
        text-transform: lowercase;
    }

    .rl-training-sync .sync-symbol {
        font-size: 14px;
        color: var(--muted-color, #999);
        font-weight: normal;
    }

    .rl-training-sync .dots {
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        color: var(--muted-color, #ccc);
        margin: 8px 0;
    }

    @media (max-width: 1100px) {
        .rl-training-sync .left-section {
            flex-direction: column;
        }

        .rl-training-sync .diagram-separator {
            width: 100%;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color, #ddd) 20%, var(--border-color, #ddd) 80%, transparent);
        }
    }

    @media (max-width: 1000px) {
        .rl-training-sync .container {
            flex-direction: column;
        }

        .rl-training-sync .left-diagram {
            max-width: 100%;
        }

        .rl-training-sync .right-modes {
            min-width: 100%;
        }
    }

    @media (max-width: 600px) {
        .rl-training-sync .right-modes {
            flex-direction: column;
        }

        .rl-training-sync .mode-column {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid var(--border-color, #ddd);
            padding: 15px;
        }

        .rl-training-sync .mode-column:last-child {
            border-bottom: none;
        }
    }
</style>

<script>
    (() => {
        const bootstrap = () => {
            const scriptEl = document.currentScript;
            let container = scriptEl ? scriptEl.previousElementSibling : null;
            if (!(container && container.classList && container.classList.contains('rl-training-sync'))) {
                const candidates = Array.from(document.querySelectorAll('.rl-training-sync'))
                    .filter((el) => !(el.dataset && el.dataset.mounted === 'true'));
                container = candidates[candidates.length - 1] || null;
            }
            if (!container) return;
            if (container.dataset) {
                if (container.dataset.mounted === 'true') return;
                container.dataset.mounted = 'true';
            }

            // Apply categorical color palette
            const applyColorPalette = () => {
                try {
                    if (window.ColorPalettes && typeof window.ColorPalettes.getColors === 'function') {
                        const colors = window.ColorPalettes.getColors('categorical', 4);
                        colors.forEach((color, index) => {
                            document.documentElement.style.setProperty(`--color-${index}`, color);
                        });
                    } else {
                        const fallbackColors = ['#E889AB', '#4EA5B7', '#E38A42', '#CEC0FA'];
                        fallbackColors.forEach((color, index) => {
                            document.documentElement.style.setProperty(`--color-${index}`, color);
                        });
                    }
                } catch (e) {
                    console.warn('ColorPalettes not available, using fallback colors');
                }
            };

            applyColorPalette();
            if (window.ColorPalettes && typeof window.ColorPalettes.refresh === 'function') {
                window.ColorPalettes.refresh();
            }

            // Node positions and sizes (calculated from CSS positions)
            // Container is 280x320
            // Box CSS: padding: 8px 14px, font-size: 11px, line-height: 1.3
            const containerWidth = 280;
            const containerHeight = 320;
            const padding = { x: 14, y: 8 };

            // Estimated text widths + padding (approximate)
            const boxWidth = {
                rewards: 58 + padding.x * 2,          // ~58px text
                verifier: 90 + padding.x * 2,         // ~90px text (2 lines)
                rollouts: 58 + padding.x * 2,         // ~58px text
                trainer: 70 + padding.x * 2,          // ~70px text
                generator: 75 + padding.x * 2,        // ~75px text
                prompt: 48 + padding.x * 2            // ~48px text
            };

            // Height: single line ≈ 14px, double line ≈ 28px + padding
            const boxHeight = {
                rewards: 14 + padding.y * 2,          // 1 line
                verifier: 28 + padding.y * 2,         // 2 lines (with <br/>)
                rollouts: 14 + padding.y * 2,         // 1 line
                trainer: 14 + padding.y * 2,          // 1 line
                generator: 14 + padding.y * 2,        // 1 line
                prompt: 14 + padding.y * 2            // 1 line
            };

            const nodes = {
                // top: 10px, left: 10px
                rewards: {
                    x: 10 + boxWidth.rewards / 2,
                    y: 10 + boxHeight.rewards / 2,
                    width: boxWidth.rewards,
                    height: boxHeight.rewards
                },
                // top: 10px, right: 10px
                verifier: {
                    x: containerWidth - 10 - boxWidth.verifier / 2,
                    y: 10 + boxHeight.verifier / 2,
                    width: boxWidth.verifier,
                    height: boxHeight.verifier
                },
                // top: 50%, right: 10px, transform: translateY(-50%)
                rollouts: {
                    x: containerWidth - 10 - boxWidth.rollouts / 2,
                    y: containerHeight / 2,
                    width: boxWidth.rollouts,
                    height: boxHeight.rollouts
                },
                // bottom: 60px, left: 10px
                trainer: {
                    x: 10 + boxWidth.trainer / 2,
                    y: containerHeight - 60 - boxHeight.trainer / 2,
                    width: boxWidth.trainer,
                    height: boxHeight.trainer
                },
                // bottom: 60px, right: 10px
                generator: {
                    x: containerWidth - 10 - boxWidth.generator / 2,
                    y: containerHeight - 60 - boxHeight.generator / 2,
                    width: boxWidth.generator,
                    height: boxHeight.generator
                },
                // bottom: 10px, left: 50%, transform: translateX(-50%)
                prompt: {
                    x: containerWidth / 2,
                    y: containerHeight - 10 - boxHeight.prompt / 2,
                    width: boxWidth.prompt,
                    height: boxHeight.prompt
                }
            };

            // Get connection point on a node's side (like bottleneck)
            // node.x and node.y are the CENTER of the box
            // We calculate the edge point, then add offset to move away from the box
            // linkIndex and totalLinks allow spacing multiple connections on the same side
            const getPoint = (nodeId, side, offset = 8, linkIndex = 0, totalLinks = 1) => {
                const node = nodes[nodeId];
                if (!node) return { x: 0, y: 0 };

                const points = {
                    top: { x: node.x, y: node.y - node.height / 2 - offset },
                    right: { x: node.x + node.width / 2 + offset, y: node.y },
                    bottom: { x: node.x, y: node.y + node.height / 2 + offset },
                    left: { x: node.x - node.width / 2 - offset, y: node.y }
                };

                let basePoint = points[side] || { x: node.x, y: node.y };

                // Apply spacing for multiple links to the same anchor
                if (totalLinks > 1) {
                    const isVerticalAnchor = (side === 'top' || side === 'bottom');

                    // Vertical anchors (top/bottom) space horizontally, horizontal anchors (left/right) space vertically
                    // Reduced gap: use fixed spacing instead of proportional
                    const spacing = 8;  // Fixed gap of 8px between links
                    const linkOffset = (linkIndex - (totalLinks - 1) / 2) * spacing;

                    // Apply offset in the perpendicular direction to the anchor
                    if (isVerticalAnchor) {
                        basePoint.x += linkOffset;  // Horizontal offset for vertical anchors
                    } else {
                        basePoint.y += linkOffset;  // Vertical offset for horizontal anchors
                    }
                }

                return basePoint;
            };

            // Create SVG paths with arrow markers (simple version)
            const createPath = (from, to, dashed = false, color = 'currentColor') => {
                return `<line x1="${from.x}" y1="${from.y}" x2="${to.x}" y2="${to.y}" 
                    stroke="${color}" stroke-width="2" 
                    ${dashed ? 'stroke-dasharray="4,4"' : ''} 
                    opacity="0.6" 
                    marker-end="url(#arrowhead)" />`;
            };

            // Build all connections
            let connections = '';
            const linkColor = 'var(--text-color, #666)';

            // 1. Rewards → Trainer (dashed, vertical)
            // Trainer top receives 2 links, this is link 0
            connections += createPath(
                getPoint('rewards', 'bottom'),
                getPoint('trainer', 'top', 8, 0, 2),
                true, linkColor
            );

            // 2. Verifier → Rewards (horizontal)
            connections += createPath(
                getPoint('verifier', 'left'),
                getPoint('rewards', 'right'),
                false, linkColor
            );

            // 3. Verifier → Rollouts (vertical)
            connections += createPath(
                getPoint('verifier', 'bottom'),
                getPoint('rollouts', 'top'),
                false, linkColor
            );

            // 4. Rollouts → Generator (vertical, single arrow)
            connections += createPath(
                getPoint('rollouts', 'bottom'),
                getPoint('generator', 'top'),
                false, linkColor
            );

            // 5. Rollouts → Trainer (diagonal: left of rollouts to top of trainer)
            // Trainer top receives 2 links, this is link 1
            connections += createPath(
                getPoint('rollouts', 'left'),
                getPoint('trainer', 'top', 8, 1, 2),
                false, linkColor
            );

            // 6. Trainer → Generator sync (dashed, horizontal)
            const trainerRight = getPoint('trainer', 'right');
            const generatorLeft = getPoint('generator', 'left');
            connections += createPath(trainerRight, generatorLeft, true, linkColor);
            const syncMidX = (trainerRight.x + generatorLeft.x) / 2;
            connections += `<text x="${syncMidX}" y="${trainerRight.y - 8}" font-size="8" fill="currentColor" opacity="0.6" font-weight="600" text-anchor="middle">sync</text>`;
            connections += `<text x="${syncMidX}" y="${trainerRight.y + 13}" font-size="8" fill="currentColor" opacity="0.6" font-weight="600" text-anchor="middle">weights</text>`;

            // 7. Prompt → Trainer (diagonal: left of prompt to bottom of trainer)
            connections += createPath(
                getPoint('prompt', 'left'),
                getPoint('trainer', 'bottom'),
                false, linkColor
            );

            // 8. Prompt → Generator (diagonal: right of prompt to bottom of generator)
            connections += createPath(
                getPoint('prompt', 'right'),
                getPoint('generator', 'bottom'),
                false, linkColor
            );

            container.innerHTML = `
            <div class="container">
                <!-- LEFT SECTION WITH DIAGRAM -->
                <div class="left-section">
                    <div class="left-diagram">
                        <!-- SVG for arrows -->
                        <svg width="100%" height="100%" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                            <defs>
                                <marker id="arrowhead" markerWidth="6" markerHeight="6" 
                                    refX="4" refY="2" orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L4,2 L0,4" 
                                        fill="none" 
                                        stroke="var(--text-color, #666)" 
                                        stroke-width="1" 
                                        stroke-linecap="round" 
                                        stroke-linejoin="round" />
                                </marker>
                            </defs>
                            ${connections}
                        </svg>
                        
                        <!-- Boxes -->
                        <div class="box rewards">Rewards</div>
                        <div class="box verifier">Reward/Verifier<br/>Model</div>
                        <div class="box rollouts">Rollouts</div>
                        <div class="box trainer">Trainer (T)</div>
                        <div class="box generator">Generator (G)</div>
                        <div class="box prompt">Prompt</div>
                    </div>
                    
                    <div class="diagram-separator"></div>
                </div>

                <!-- RIGHT MODES -->
                <div class="right-modes">
                    <!-- OFFLINE -->
                    <div class="mode-column">
                        <div class="mode-header">Offline (s=∞)</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k+1</span>
                            <span class="node node-t">T</span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k</span>
                            <span class="node node-t">T</span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="dots">⋯</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 1</span>
                            <span class="node node-t">T</span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 0</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                    </div>

                    <!-- SEMI-ONLINE -->
                    <div class="mode-column">
                        <div class="mode-header">Semi-Online (s=k)</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k+1</span>
                            <span class="node node-t">T</span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="dots">⋯</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 1</span>
                            <span class="node node-t">T</span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 0</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                    </div>

                    <!-- ONLINE -->
                    <div class="mode-column">
                        <div class="mode-header">Online (s=1)</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k+1</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step k</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="dots">⋯</div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 1</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                        
                        <div class="step-row">
                            <span class="step-label">Step 0</span>
                            <span class="node node-t">T</span>
                            <span class="sync-arrow">
                                <span class="sync-label">sync</span>
                                <span class="sync-symbol">⟶</span>
                            </span>
                            <span class="node node-g">G</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bootstrap, { once: true });
        } else {
            bootstrap();
        }
    })();
</script>